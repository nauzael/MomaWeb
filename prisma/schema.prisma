generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// User model for NextAuth.js
model User {
  id            String    @id @default(uuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  image         String?
  password      String?
  role          String    @default("user") // admin, editor, user
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  accounts      Account[]
  sessions      Session[]
  bookings      Booking[]
}

// NextAuth.js Account model
model Account {
  id                 String  @id @default(uuid())
  userId             String
  type               String
  provider           String
  providerAccountId  String
  refresh_token      String? @db.Text
  access_token       String? @db.Text
  expires_at         Int?
  token_type         String?
  scope              String?
  id_token           String? @db.Text
  session_state      String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

// NextAuth.js Session model
model Session {
  id           String   @id @default(uuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// VerificationToken for passwordless auth
model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// Experiences (Mapped from existing table)
model Experience {
  id             String   @id @default(uuid())
  title          String
  slug           String   @unique
  description    String?  @db.Text
  image          String?  @default("")
  gallery        Json?    // Stored as JSON array
  priceCop       Decimal? @map("price_cop")
  priceUsd       Decimal? @map("price_usd")
  locationName   String?  @map("location_name")
  
  // Handling Geo: MySQL doesn't store coordinates as a single native type easily without spatial extensions.
  // We'll store lat/lng separately for simplicity and Prisma compatibility.
  locationLat    Float?   @map("location_lat")
  locationLng    Float?   @map("location_lng")
  
  includes       Json?    // JSON array
  excludes       Json?    // JSON array
  recommendations String? @db.Text
  maxCapacity    Int?     @map("max_capacity")
  
  updatedAt      DateTime @default(now()) @updatedAt @map("updated_at")
  createdAt      DateTime @default(now()) @map("created_at")

  media          ExperienceMedia[]
  bookings       Booking[]

  @@map("experiences")
}

// Media associated with experiences
model ExperienceMedia {
  id           String     @id @default(uuid())
  experienceId String     @map("experience_id")
  url          String
  type         String     // 'image' or 'video'
  order        Int        @default(0)
  createdAt    DateTime   @default(now()) @map("created_at")

  experience   Experience @relation(fields: [experienceId], references: [id], onDelete: Cascade)

  @@map("experience_media")
}

// Bookings
model Booking {
  id            String   @id @default(uuid())
  experienceId  String   @map("experience_id")
  userId        String?  // Optional link to registered user
  customerName  String   @map("customer_name")
  customerEmail String   @map("customer_email")
  travelDate    DateTime @map("travel_date") @db.Date
  guestsCount   Int      @map("guests_count")
  totalAmount   Decimal  @map("total_amount")
  currency      String   @default("COP")
  status        String   @default("pending") // pending, confirmed, cancelled
  createdAt     DateTime @default(now()) @map("created_at")

  experience   Experience @relation(fields: [experienceId], references: [id])
  user         User?      @relation(fields: [userId], references: [id])
  payments     Payment[]

  @@map("bookings")
}

// Payments
model Payment {
  id            String   @id @default(uuid())
  bookingId     String   @map("booking_id")
  gateway       String?  // wompi, stripe
  transactionId String?  @map("transaction_id")
  paymentStatus String?  @map("payment_status")
  createdAt     DateTime @default(now()) @map("created_at")

  booking       Booking  @relation(fields: [bookingId], references: [id])

  @@map("payments")
}

// Gallery images (Separate from experiences)
model GalleryImage {
  id        Int      @id @default(autoincrement())
  url       String
  createdAt DateTime @default(now()) @map("created_at")

  @@map("gallery_images")
}

// Roles and permissions
model Role {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?  @db.Text
  permissions Json     // List of strings
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("roles")
}


